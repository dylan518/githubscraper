package net.notjustanna;

import javafx.application.Application;
import javafx.application.Platform;
import javafx.concurrent.Worker;
import javafx.scene.Scene;
import javafx.scene.layout.Priority;
import javafx.scene.layout.VBox;
import javafx.scene.web.WebView;
import javafx.stage.Stage;
import org.w3c.dom.html.HTMLBodyElement;
import org.w3c.dom.html.HTMLDivElement;
import org.w3c.dom.html.HTMLHeadElement;
import org.w3c.dom.html.HTMLLinkElement;

import java.io.*;
import java.util.Objects;

public class Main extends Application {
    public static void main(String[] args) {
        launch(args);
    }
    
    public void start(Stage primaryStage) {
        primaryStage.setOnCloseRequest(e -> {
            Platform.exit();
        });

        primaryStage.setTitle("JavaFX Front-end");

        WebView webView = new WebView();

        var engine = webView.getEngine();

        try(
            InputStream stream = this.getClass().getResourceAsStream("./index.html");
            InputStreamReader reader = new InputStreamReader(Objects.requireNonNull(stream));
            StringWriter writer = new StringWriter()
        ) {
            reader.transferTo(writer);
            engine.loadContent(writer.toString());
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        engine.getLoadWorker().stateProperty().addListener((observable, oldValue, newValue) -> {
            if (newValue != Worker.State.SUCCEEDED) {
                return;
            }
            var document = engine.getDocument();
            var head = (HTMLHeadElement) document.getElementsByTagName("head").item(0);
            var css = (HTMLLinkElement) document.createElement("link");
            css.setRel("stylesheet");
            css.setHref(Objects.requireNonNull(this.getClass().getResource("index.css")).toExternalForm());
            head.appendChild(css);

            var body = (HTMLBodyElement) document.getElementsByTagName("body").item(0);
            var div = (HTMLDivElement) document.createElement("div");
            div.appendChild(document.createTextNode("JavaFX generated element"));
            body.appendChild(div);
        });
        VBox vBox = new VBox(webView);
        VBox.setVgrow(webView, Priority.ALWAYS);
        Scene scene = new Scene(vBox, 960, 600);

        primaryStage.setScene(scene);
        primaryStage.show();
    }
}
